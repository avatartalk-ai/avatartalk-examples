<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AvatarTalk ¬∑ Knowledge Base</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #0b1020;
      color: #e7e9ee;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 22px;
    }

    .small {
      color: #9aa3b2;
      font-size: 12px;
      margin-bottom: 16px;
    }

    .chat {
      background: #0f1428;
      border: 1px solid #1f2a44;
      border-radius: 12px;
      padding: 16px;
      min-height: 320px;
    }

    .msg {
      padding: 8px 10px;
      margin: 6px 0;
      border-radius: 8px;
      max-width: 80%;
      white-space: pre-wrap;
    }

    .user {
      background: #1b2645;
      align-self: flex-end;
    }

    .assistant {
      background: #152036;
    }

    .row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    input[type=text] {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #314066;
      background: #0f1428;
      color: #e7e9ee;
    }

    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #314066;
      background: #1b2645;
      color: #e7e9ee;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: wait;
    }

    .video-wrap {
      margin-top: 16px;
    }

    video,
    iframe {
      width: 100%;
      max-height: 420px;
      border-radius: 8px;
      border: 1px solid #1f2a44;
      background: #000;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>AvatarTalk ¬∑ Knowledge Base</h1>
    <div class="small">Model: {{ model }} ¬∑ Avatar: {{ avatar }} ¬∑ Emotion: {{ emotion }} ¬∑ Language: {{ language }} ¬∑
      Delayed: {{ 'on' if delayed else 'off' }}</div>

    <div id="chat" class="chat" style="display: flex; flex-direction: column;"></div>

    <div class="row">
      <input id="text" type="text" placeholder="Type your message and press Send" />
      <button id="send">Send</button>
      <button id="ptt" title="Hold to talk">üéôÔ∏è Hold to talk</button>
    </div>
    <div class="row" style="gap: 12px; flex-wrap: wrap; align-items: center;">
      <label>Avatar
        <select id="sel-avatar">
          <option value="japanese_man" {{ 'selected' if avatar=='japanese_man' else '' }}>Japanese Man</option>
          <option value="old_european_woman" {{ 'selected' if avatar=='old_european_woman' else '' }}>Elderly Woman
          </option>
          <option value="european_woman" {{ 'selected' if avatar=='european_woman' else '' }}>European Woman</option>
          <option value="european_man" {{ 'selected' if avatar=='european_man' else '' }}>European Man</option>
          <option value="african_man" {{ 'selected' if avatar=='african_man' else '' }}>African Man</option>
          <option value="african_woman" {{ 'selected' if avatar=='african_woman' else '' }}>African Woman</option>
          <option value="japanese_woman" {{ 'selected' if avatar=='japanese_woman' else '' }}>Japanese Woman</option>
          <option value="iranian_man" {{ 'selected' if avatar=='iranian_man' else '' }}>Iranian Man</option>
          <option value="mexican_man" {{ 'selected' if avatar=='mexican_man' else '' }}>Mexican Man</option>
          <option value="mexican_woman" {{ 'selected' if avatar=='mexican_woman' else '' }}>Mexican Woman</option>
          <option value="colombian_woman" {{ 'selected' if avatar=='colombian_woman' else '' }}>Colombian Woman</option>
          <option value="old_japanese_man" {{ 'selected' if avatar=='old_japanee_man' else '' }}>Elderly Japanese Man</option>
          <option value="arab_man" {{ 'selected' if avatar=='arab_man' else '' }}>Arab Man</option>
          <option value="arab_woman" {{ 'selected' if avatar=='arab_woman' else '' }}>Arab Woman</option>
        </select>
      </label>
      <label>Emotion
        <select id="sel-emotion">
          <option value="neutral" {{ 'selected' if emotion=='neutral' else '' }}>Neutral</option>
          <option value="happy" {{ 'selected' if emotion=='happy' else '' }}>Happy</option>
          <option value="serious" {{ 'selected' if emotion=='serious' else '' }}>Serious</option>
        </select>
      </label>
      <label>Language
        <select id="sel-language">
          <option value="en" {{ 'selected' if language=='en' else '' }}>English (en)</option>
          <option value="es" {{ 'selected' if language=='es' else '' }}>Spanish (es)</option>
          <option value="fr" {{ 'selected' if language=='fr' else '' }}>French (fr)</option>
          <option value="de" {{ 'selected' if language=='de' else '' }}>German (de)</option>
          <option value="it" {{ 'selected' if language=='it' else '' }}>Italian (it)</option>
          <option value="pt" {{ 'selected' if language=='pt' else '' }}>Portuguese (pt)</option>
          <option value="pl" {{ 'selected' if language=='pl' else '' }}>Polish (pl)</option>
          <option value="tr" {{ 'selected' if language=='tr' else '' }}>Turkish (tr)</option>
          <option value="ru" {{ 'selected' if language=='ru' else '' }}>Russian (ru)</option>
          <option value="nl" {{ 'selected' if language=='nl' else '' }}>Dutch (nl)</option>
          <option value="cs" {{ 'selected' if language=='cs' else '' }}>Czech (cs)</option>
          <option value="ar" {{ 'selected' if language=='ar' else '' }}>Arabic (ar)</option>
          <option value="cn" {{ 'selected' if language=='zh' else '' }}>Chinese (zh)</option>
          <option value="ja" {{ 'selected' if language=='ja' else '' }}>Japanese (ja)</option>
          <option value="hu" {{ 'selected' if language=='hu' else '' }}>Hungarian (hu)</option>
          <option value="ko" {{ 'selected' if language=='ko' else '' }}>Korean (ko)</option>
          <option value="hi" {{ 'selected' if language=='hi' else '' }}>Hindi (hi)</option>
        </select>
      </label>
    </div>
    <div class="row" style="align-items:center">
      <label style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" id="streaming" />
        Stream video in real time
      </label>
    </div>

    <div id="video-wrap" class="video-wrap hidden">
      <h3>Avatar Response Video</h3>
      <video id="video" controls autoplay playsinline></video>
      <div class="small" id="video-links"></div>
    </div>
  </div>

  <script>
    const $chat = document.getElementById('chat');
    const $text = document.getElementById('text');
    const $send = document.getElementById('send');
    const $video = document.getElementById('video');
    const $videoWrap = document.getElementById('video-wrap');
    const $videoLinks = document.getElementById('video-links');
    const $selAvatar = document.getElementById('sel-avatar');
    const $selEmotion = document.getElementById('sel-emotion');
    const $selLanguage = document.getElementById('sel-language');
    const $streaming = document.getElementById('streaming');

    function resetVideo() {
      try { $video.pause(); } catch { }
      $video.removeAttribute('src');
      $video.load();
      $videoLinks.innerHTML = '';
    }

    /** Keep a minimal message history for OpenAI context */
    const history = [];

    function addMsg(role, content) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = content;
      $chat.appendChild(div);
      $chat.scrollTop = $chat.scrollHeight;
    }

    async function send() {
      const text = $text.value.trim();
      if (!text) return;
      $text.value = '';
      addMsg('user', text);
      history.push({ role: 'user', content: text });

      $send.disabled = true;
      try {
        resetVideo();
        if ($streaming.checked) {
          const resp = await fetch('/chat_stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_text: text, history,
              avatar: $selAvatar.value,
              emotion: $selEmotion.value,
              language: $selLanguage.value,
            })
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || 'Request failed');
          const assistant = data.assistant_text || '';
          addMsg('assistant', assistant);
          history.push({ role: 'assistant', content: assistant });
          if (data.stream_url) {
            $video.src = data.stream_url;
            $videoWrap.classList.remove('hidden');
            $videoLinks.innerHTML = 'Streaming‚Ä¶';
            try { await $video.play(); } catch { }
          }
        } else {
          const resp = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_text: text, history,
              avatar: $selAvatar.value,
              emotion: $selEmotion.value,
              language: $selLanguage.value,
            })
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || 'Request failed');
          const assistant = data.assistant_text || '';
          addMsg('assistant', assistant);
          history.push({ role: 'assistant', content: assistant });
          const inf = data.inference || {};
          if (inf.mp4_url) {
            $video.src = inf.mp4_url;
            $videoWrap.classList.remove('hidden');
            try { await $video.play(); } catch { }
          }
          const links = [];
          if (inf.mp4_url) links.push(`<a href="${inf.mp4_url}" target="_blank" rel="noopener">MP4</a>`);
          if (inf.html_url) links.push(`<a href="${inf.html_url}" target="_blank" rel="noopener">Viewer</a>`);
          $videoLinks.innerHTML = links.length ? `Links: ${links.join(' ¬∑ ')}` : '';
        }
      } catch (err) {
        addMsg('assistant', `Error: ${err.message || err}`);
      } finally {
        $send.disabled = false;
      }
    }

    $send.addEventListener('click', send);
    $text.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') send();
    });

    // Push-to-talk: Record while button is held, send when released
    const $ptt = document.getElementById('ptt');
    let mediaRecorder = null;
    let chunks = [];
    let stream = null;

    async function startRecording() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        chunks = [];
        const preferred = 'audio/webm';
        const opts = MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(preferred)
          ? { mimeType: preferred }
          : undefined;
        mediaRecorder = new MediaRecorder(stream, opts);
        mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
        mediaRecorder.onstop = async () => {
          try {
            const blobType = mediaRecorder.mimeType || 'audio/webm';
            const blob = new Blob(chunks, { type: blobType });
            const form = new FormData();
            const ext = blobType.includes('webm') ? 'webm' : (blobType.includes('mp4') ? 'm4a' : 'ogg');
            form.append('audio', blob, `ptt.${ext}`);

            $ptt.disabled = true;
            // 1) Transcribe first, show user text immediately
            const tr = await fetch('/transcribe', { method: 'POST', body: form });
            const trData = await tr.json();
            if (!tr.ok) throw new Error(trData.error || 'Transcription failed');
            const userText = trData.user_text || '(unrecognized speech)';
            addMsg('user', userText);
            history.push({ role: 'user', content: userText });

            // 2) Based on streaming toggle, either init stream or do regular chat
            resetVideo();
            if ($streaming.checked) {
              const resp = await fetch('/chat_stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  user_text: userText, history,
                  avatar: $selAvatar.value,
                  emotion: $selEmotion.value,
                  language: $selLanguage.value,
                })
              });
              const data = await resp.json();
              if (!resp.ok) throw new Error(data.error || 'Voice stream init failed');
              const assistant = data.assistant_text || '';
              addMsg('assistant', assistant);
              history.push({ role: 'assistant', content: assistant });
              if (data.stream_url) {
                $video.src = data.stream_url;
                $videoWrap.classList.remove('hidden');
                $videoLinks.innerHTML = 'Streaming‚Ä¶';
                try { await $video.play(); } catch { }
              }
            } else {
              const resp = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  user_text: userText, history,
                  avatar: $selAvatar.value,
                  emotion: $selEmotion.value,
                  language: $selLanguage.value,
                })
              });
              const data = await resp.json();
              if (!resp.ok) throw new Error(data.error || 'Voice request failed');
              const assistant = data.assistant_text || '';
              addMsg('assistant', assistant);
              history.push({ role: 'assistant', content: assistant });
              const inf = data.inference || {};
              if (inf.mp4_url) {
                $video.src = inf.mp4_url;
                $videoWrap.classList.remove('hidden');
                try { await $video.play(); } catch { }
              }
              const links = [];
              if (inf.mp4_url) links.push(`<a href="${inf.mp4_url}" target="_blank" rel="noopener">MP4</a>`);
              if (inf.html_url) links.push(`<a href="${inf.html_url}" target="_blank" rel="noopener">Viewer</a>`);
              $videoLinks.innerHTML = links.length ? `Links: ${links.join(' ¬∑ ')}` : '';
            }
          } catch (err) {
            addMsg('assistant', `Voice error: ${err.message || err}`);
          } finally {
            $ptt.disabled = false;
          }
        };
        mediaRecorder.start();
        $ptt.textContent = '‚óè Recording...';
        $ptt.style.background = '#8a1b1b';
      } catch (err) {
        addMsg('assistant', `Mic error: ${err.message || err}`);
      }
    }

    function stopRecording() {
      try {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
      } finally {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
        $ptt.textContent = 'üéôÔ∏è Hold to talk';
        $ptt.style.background = '';
      }
    }

    // Mouse and touch events for push-to-talk
    $ptt.addEventListener('mousedown', (e) => { e.preventDefault(); startRecording(); });
    $ptt.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
    // Stop on release or leaving the button area
    const stopEvents = ['mouseup', 'mouseleave', 'touchend', 'touchcancel'];
    stopEvents.forEach(ev => $ptt.addEventListener(ev, (e) => { e.preventDefault(); stopRecording(); }));
  </script>
</body>

</html>

